<!DOCTYPE html>
<html lang="en" ng-app="app">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="images/icon.png">
<title>{{site.title}}</title>
<!-- Bootstrap -->
<link href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<link href="http://cdn.bootcss.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
<link href="http://cdn.bootcss.com/toastr.js/latest/css/toastr.min.css" rel="stylesheet">
<!-- Custom styles for this template -->

<!--[if !IE]> -->
<script type="text/javascript">
window.jQuery || document.write("<script src='http://cdn.bootcss.com/jquery/2.1.1/jquery.min.js'>"+"<"+"/script>");
</script>
<!-- <![endif]-->
<!--[if IE]>
<script type="text/javascript">
window.jQuery || document.write("<script src='http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>"+"<"+"/script>");
</script>
<![endif]-->

</head>
<body ng-controller="AppCtl" scrollOffTop class="{{bodycss}}">

<div ui-view></div>

<modal-dialog key='signup_by_email' show='mdData.show' width='660px' dialog-title='邮箱注册'>
	<div class="row">
		<div class="col-md-7 seprate">
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-3 control-label">用户名:</label>
					<div class="col-sm-9">
						<input type="text" ng-model="mdData.username" class="form-control" placeholder="请在此输入您的用户名(3~15字符)">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">E-mail:</label>
					<div class="col-sm-9">
						<input type="email" ng-model="mdData.email" class="form-control" placeholder="在此输入您的Email">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">密码:</label>
					<div class="col-sm-9">
						<input type="password" ng-model="mdData.password" class="form-control" placeholder="请输入您的密码">
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<div class="checkbox">
							<label class="control-label">
								<input type="checkbox" ng-model="mdData.agree"> 同意用户协议
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<button ng-click="doSignup()" class="btn btn-default btn-success">提交注册信息</button>
					</div>
				</div>
			</form>
		</div>
		<div class="col-md-4 col-md-offset-1">
			<h4>已有{{site.title}}账号？</h4><br>
			<button ng-click="toggleModal('signin')" class="btn btn-info btn-sm">登陆</button>
			<br><br><br>
			<h6>或使用以下账号直接登陆</h6>
			<a ng-click="mdSignQQ()"><img src="/img/qq_login.png" alt="qq"></a>
		</div>
	</div>
</modal-dialog>
<modal-dialog key='signup_by_mobile' show='mdData.show' width='660px' dialog-title='手机注册'>
	<div class="row">
		<div class="col-md-7 seprate">
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-3 control-label">用户名:</label>
					<div class="col-sm-9">
						<input type="text" ng-model="mdData.username" class="form-control" placeholder="请在此输入您的用户名(3~15字符)">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">手机号:</label>
					<div class="col-sm-9">
						<input type="text" ng-model="mdData.mobile" class="form-control" placeholder="在此输入您的手机号码">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">验证码:</label>
					<div class="col-sm-9">
						<div class="input-group">
							<input type="text" class="form-control" ng-model="mdData.sms" placeholder="输入验证码">
							<span class="input-group-btn">
								<button class="btn btn-sm btn-default  form-control" type="button" ng-disabled="mdData.smsDisable" ng-click="sendSms()">
									<i class="icon-calendar bigger-110"></i>发送验证码!
								</button>
							</span>
						</div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">密码:</label>
					<div class="col-sm-9">
						<input type="password" ng-model="mdData.password" class="form-control" placeholder="请输入您的密码">
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<div class="checkbox">
							<label class="control-label">
								<input type="checkbox" ng-model="mdData.agree"> 同意用户协议
							</label>
						</div>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<button ng-click="doSignup()" class="btn btn-default btn-success">提交注册信息</button>
					</div>
				</div>
			</form>
		</div>
		<div class="col-md-4 col-md-offset-1">
			<h4>已有{{site.title}}账号？</h4><br>
			<button ng-click="toggleModal('signin')" class="btn btn-info btn-sm">登陆</button>
			<br><br><br>
			<h6>或使用以下账号直接登陆</h6>
			<a ng-click="mdSignQQ()"><img src="/img/qq_login.png" alt="qq"></a>
		</div>
	</div>
</modal-dialog>
<modal-dialog key="signin" show='mdData.show' width='660px' dialog-title='登陆'>
	<div class="row">
		<div class="col-md-7 seprate">
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-3 control-label">用户名:</label>
					<div class="col-sm-9">
						<input type="text" class="form-control" ng-model="mdData.username" placeholder="用户名 , 手机号 , Email">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">密码:</label>
					<div class="col-sm-9">
						<input type="password" ng-model="mdData.password" class="form-control" placeholder="请输入您的密码">
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						找回密码通过 <a ng-click="toggleModal('forgot_by_email')" class="control-label">邮箱</a> | <a ng-click="toggleModal('forgot_by_mobile')" class="control-label">手机</a> 
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<button ng-click="doSignin()" class="btn btn-default btn-success">登陆</button>
					</div>
				</div>
			</form>
		</div>
		<div class="col-md-4 col-md-offset-1">
			<h4>还没有{{site.title}}账号？</h4><br>
			<button ng-click="toggleModal('signup_by_email')" class="btn btn-info btn-sm">邮箱注册</button>
			<button ng-click="toggleModal('signup_by_mobile')" class="btn btn-info btn-sm">手机注册</button>
			<br><br><br>
			<h6>或使用以下账号直接登陆</h6>
			<a ng-click="mdSignQQ()"><img src="/img/qq_login.png" alt="qq"></a>
		</div>
	</div>
</modal-dialog>
<modal-dialog key="forgot_by_email" show='mdData.show' width='660px' dialog-title='找回密码'>
	<div class="row">
		<div class="col-md-8 col-md-offset-2 seprate">
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-3 control-label">Email:</label>
					<div class="col-sm-9">
						<input type="email" ng-model="mdData.email" class="form-control" placeholder="在此输入您注册时的Email">
						<p class="help-block">此功能将会发送一个找回密码的特别链接到你的邮箱，通过该链接可以进入重置密码的页面.</p>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<button ng-click="doForgot()" class="btn btn-default btn-success">找回密码</button>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<h5><a ng-click="toggleModal('signin')">登陆</a> - <a ng-click="toggleModal('signup_by_email')">注册会员</a></h5><br>
						<br><br>
						<h6>也可以使用第三方账号登陆</h6>
						<a ng-click="mdSignQQ()"><img src="/img/qq_login.png" alt="qq"></a>
					</div>
				</div>	
			</form>
		</div>
	</div>
</modal-dialog>
<modal-dialog key="forgot_by_mobile" show='mdData.show' width='660px' dialog-title='找回密码'>
	<div class="row">
		<div class="col-md-8 col-md-offset-2 seprate">
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-3 control-label">手机号:</label>
					<div class="col-sm-9">
						<input type="text" ng-model="mdData.username" class="form-control" placeholder="输入注册的用户名或手机号">
						<p class="help-block">此功能将会发送一个手机验证码到你的手机，正确填写验证码和新设定的密码，进入系统.</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">验证码:</label>
					<div class="col-sm-9">
						<div class="input-group">
							<input type="text" class="form-control" ng-model="mdData.sms" placeholder="输入验证码">
							<span class="input-group-btn">
								<button class="btn btn-sm btn-default" type="button" ng-disabled="mdData.smsDisable" ng-click="sendSms()">
									<i class="icon-calendar bigger-110"></i>发送验证码!
								</button>
							</span>
						</div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">新密码:</label>
					<div class="col-sm-9">
						<input type="password" ng-model="mdData.password" class="form-control" placeholder="请输入新的密码">
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<button ng-click="doForgot()" class="btn btn-default btn-success">找回密码</button>
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-3 col-sm-9">
						<h5><a ng-click="toggleModal('signin')">登陆</a> - <a ng-click="toggleModal('signup_by_mobile')">注册会员</a></h5><br>
						<br><br>
						<h6>也可以使用第三方账号登陆</h6>
						<a ng-click="mdSignQQ()"><img src="/img/qq_login.png" alt="qq"></a>
					</div>
				</div>	
			</form>
		</div>
	</div>
</modal-dialog>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://cdn.bootcss.com/lodash.js/2.4.1/lodash.min.js"></script>
<script src="http://cdn.bootcss.com/toastr.js/latest/js/toastr.min.js"></script>
<script src="http://cdn.bootcss.com/angular.js/1.2.16/angular.min.js"></script>
<script src="http://cdn.bootcss.com/angular-ui-router/0.2.10/angular-ui-router.min.js"></script>
<script src="/js/mqttws31.js"></script>

<script type="text/javascript">
'use strict';
angular.module("app",["ui.router"])
.factory('$transition', ['$q', '$timeout', '$rootScope', function($q, $timeout, $rootScope) {
	var $transition = function(element, trigger, options) {
		options = options || {};
		var deferred = $q.defer();
		var endEventName = $transition[options.animation ? 'animationEndEventName' : 'transitionEndEventName'];
		var transitionEndHandler = function(event) {
			$rootScope.$apply(function() {
				element.unbind(endEventName, transitionEndHandler);
				deferred.resolve(element);
			});
		};
		if (endEventName) {
			element.bind(endEventName, transitionEndHandler);
		}

		$timeout(function() {
			if ( angular.isString(trigger) ) {
				element.addClass(trigger);
			} else if ( angular.isFunction(trigger) ) {
				trigger(element);
			} else if ( angular.isObject(trigger) ) {
				element.css(trigger);
			}
			if ( !endEventName ) {
				deferred.resolve(element);
			}
		});
		deferred.promise.cancel = function() {
			if ( endEventName ) {
				element.unbind(endEventName, transitionEndHandler);
			}
			deferred.reject('Transition cancelled');
		};
		return deferred.promise;
	};

	var transElement = document.createElement('trans');
	var transitionEndEventNames = {
		'WebkitTransition': 'webkitTransitionEnd',
		'MozTransition': 'transitionend',
		'OTransition': 'oTransitionEnd',
		'transition': 'transitionend'
	};
	var animationEndEventNames = {
		'WebkitTransition': 'webkitAnimationEnd',
		'MozTransition': 'animationend',
		'OTransition': 'oAnimationEnd',
		'transition': 'animationend'
	};
	function findEndEventName(endEventNames) {
		for (var name in endEventNames){
			if (transElement.style[name] !== undefined) {
				return endEventNames[name];
			}
		}
	}
	$transition.transitionEndEventName = findEndEventName(transitionEndEventNames);
	$transition.animationEndEventName = findEndEventName(animationEndEventNames);
	return $transition;
}])
.factory('authInterceptor', ["$rootScope", "$q", "$window", function ($rootScope, $q, $window) {
	return {
		request: function (config) {
			config.headers = config.headers || {};
			if ($window.sessionStorage.token) {
				config.headers.Authorization = 'Bearer ' + $window.sessionStorage.token;
			}
			return config;
		},
		response: function (response) {
			if (response.status === 401) {
				// handle the case where the user is not authenticated
			}
			return response || $q.when(response);
		}
	};
}])
.factory('Socket', ["$rootScope", "$window", function($rootScope) {
	var service = {}, client = {};
	service.connect = function(host, port, mobile, token) {
		console.log("Try to connect to MQTT Broker " + host);
		client = mqtt.createClient(parseInt(port),host,{clientId:mobile, token:token});
		client.subscribe(mobile); 

		client.on('error', function(err) {
			console.log('error!', err);
			client.stream.end();
		});

		client.on('message', function (topic, message) {
			service.callback(topic,message);
		});
	}

	service.publish = function(topic, payload) {
		client.publish(topic,payload, {retain: true});
		console.log('publish-Event sent '+ payload + ' with topic: ' + topic + ' ' + client);
	}

	service.onMessage = function(callback) {
		service.callback = callback;
	}
	return service;
}])
.factory('serv', ["$rootScope", "$window", "$http", "$state", function($rootScope, $window, $http, $state) {
	return {
		get: function(url, param, cb){
			if(typeof(param) == "function"){
				cb = param;
				param = {};
			}
			$http.get(url, param).success(function(data, status, headers, config){
				if(data.error){
					toastr.message(data.error);
					return;
				}
				cb(data)
			}).error(function(data, status, headers, config){
				var err = {status:status, title:"未知错误!",message:""};
				if($rootScope.user && $rootScope.user.username == "kevinchen8621"){ 
					err.message = "[url:"+config.url+"]" + "[method:"+config.method+"]"+ "[data:"+JSON.stringify(config.data)+"]";
				}
				if(status == 502){
					err.title = "网关错误!";
					err.message = "远程服务器访问失败，检查网络或联系管理员！\n" + err.message;
				}
				toastr.error(err.message, err.title);
			});
		},
		post: function(url, param, cb){
			if(typeof(param) == "function"){
				cb = param;
				param = {};
			}
			$http.post(url, param).success(function(data, status, headers, config){
				if(data.error){
					toastr.message(data.error);
					return;
				}
				cb(data)
			}).error(function(data, status, headers, config){
				var err = {title:"未知错误!" + status, message:""};
				if($rootScope.user && $rootScope.user.username == "kevinchen8621"){ 
					err.message = "[url:"+config.url+"]" + "[method:"+config.method+"]"+ "[data:"+JSON.stringify(config.data)+"]";
				}
				if(status == 502){
					err.title = "网关错误!";
					err.message = "远程服务器访问失败，检查网络或联系管理员！\n" + err.message;
				}
				toastr.error(err.message, err.title);
			});
		},
	}
}])
.factory('servCat', ["$rootScope", "$window", "serv", function($rootScope, $window, serv) {
	return {
		newOne : function(pcat, cb){
			cb = cb || angular.noop;
			var newKey,item;
			var regex = new RegExp("^" + pcat.key + "\\d{2}$","g");
			var sublst = $window._.filter($rootScope.cats, function(item){  return regex.test(item.key); });
			if(sublst.length > 0){
				var subkeylst =$window._.pluck(sublst, "key");
				newKey = (Number("1" + $window._.max(subkeylst)) + 1).toString().substr(1);
			}else{
				newKey = pcat.key + "01";
			}
			item = {
				hostname: $rootScope.site._id,
				type: pcat.type, 
				key: newKey,
				title: "",
				face: "/img/0101.jpg",
				priority: 50,
				description:"",
			};
			cb(item);
		},
		save : function(cat, cb){
			cb = cb || angular.noop;
			serv.post("/api/cat", cat, function(data){
								var idx = $window._.findIndex($rootScope.cats, function(item){
					return item._id == data.cat._id;
				});
				if(idx > -1){
					$rootScope.cats.splice(idx,1,data.cat);
					cb("分类[" + data.cat.title + "]的修改信息已提交");
				}else{
					$rootScope.cats.push(data.cat);
					cb("新分类[" + data.cat.title + "]已提交");
				}
			});
		},
		del : function(cat, cb){
			if(cat._id){
				serv.post("/api/cat/del", cat, function(data){//返回{cat_ids: 删除掉的id}
										var cat_ids = data.cat_ids || [ ];
					$rootScope.cats = $window._.filter($rootScope.cats, function(item){
						return $window._.indexOf(cat_ids, item._id) == -1;
					});
					cb("分类 " + cat.title + "已删除,连带删除子分类" + (cat_ids.length - 1) + '个');
				});
			}else{
				cb("分类 " + cat.title + "已删除");
			}
		},
	};
}])
.factory('servVideo', ["$rootScope", "$window", "serv", function($rootScope, $window, serv) {
	return {
		visit : function(video_id, cb){
			cb = cb || angular.noop;
			var visitObj = $rootScope.user ? {user_id:$rootScope.user._id, video_id: video_id} : {video_id: video_id};
			serv.post('/api/video/visit',visitObj, function(data){
				cb(data);
			});
		},
		getById : function(video_id, cb){
			cb = cb || angular.noop;
			var item = $window._.find($rootScope.videos,{_id: video_id}); 
			if(item){
				cb(item);
			}else{
				serv.get('/api/video/' + video_id, function(data){
					cb(data.video);
				});
			}
		},
		getListByCatKey : function(key, cb){
			cb = cb || angular.noop;
			var vList = $window._.filter($rootScope.videos, function(item){ return $window._.indexOf(item.cats, key) > -1; });
			cb(vList);
		},
		getMyVisitList : function(cb){
			serv.get("/api/video/my_visit_ids", function(data){
				var video_ids = data.video_ids || [ ];
				var myVisitVideos = $window._.filter($rootScope.videos, function(item){
					return $window._.contains(video_ids, item._id);
				});
				cb(myVisitVideos);
			});
		},
		newOne : function(cb){
			cb = cb || angular.noop;
			var item = {
				hostname:$rootScope.site._id,
				title:"", 
				url:"",
				cats:[],
				face: "/img/0202.jpg",
				visits: 50,
				create_at: Date.now(),
				description:"",
			};
			cb(item);
		},
		save : function(video, cb){
			serv.post("/api/video", video, function(data){
								var idx = $window._.findIndex($rootScope.videos, function(item){return item._id == data._id;});
				if(idx > -1){
					$rootScope.videos.splice(idx,1,data);
					cb("视频[" + data.title + "]的修改信息已提交");
				}else{
					$rootScope.videos.push(data);
					cb("新视频[" + data.title + "]已提交");
				}
			});
		},
		del : function(video, cb){
			if(video._id){
				serv.post("/api/video/del", video, function(data){
										var idx = $window._.findIndex($rootScope.videos, function(item){
						return item._id == video._id;
					});
					if(idx > -1){$rootScope.videos.splice(idx,1);}
					cb("视频信息 " + video.title + "已删除");
				});
			}else{
				cb("视频信息 " + video.title + "已删除");
			}
		},
	};
}])
.factory('servUser', ["$rootScope", "$window", "serv", "$state", function($rootScope, $window, serv, $state) {
	return {
		init : function(){
			$rootScope.user = JSON.parse($window.sessionStorage.user || $window.localStorage.user || null);
		},
		sendSignSms : function(mdData, cb){
			var seconds = mdData.smsInterval;
			function leftCount(){
				cb(seconds--);
				$timeout(leftCount, 1000);
			}			
			serv.post('/api/signsms',{_id:mdData.mobile, org:org}, function(data){
				leftCount();
			});
		},
		signUp : function(mdData, cb){
			var u = $window._.pick(mdData, "mobile","email","sms","username","password");
			serv.post('/api/signup', u, function(data){
				$rootScope.user = data.user;
				$window.localStorage.token = data.token;
				$window.localStorage.user = JSON.stringify(data.user);
			});
		},
		signIn : function(mdData, cb){
			var u = $window._.pick(mdData, "username","password");
			serv.post('/api/signin', u, function(data){
				$rootScope.user = data.user;
				var storage = remember ? $window.localStorage : $window.sessionStorage;
				storage.token = data.token;
				storage.user = JSON.stringify(data.user);
				
			});			
		},
		forgot : function(mdData,by,cb){
			var u;
			if(by == "email"){
				u = $window._.pick(mdData, "email");
			}else if(by == "mobile"){
				u = $window._.pick(mdData, "username", "password", "sms");
			}
			serv.post('/api/forgot', u, function(data){
								if(by == "mobile"){
					$rootScope.user = data.user;
					$window.sessionStorage.token = data.token;
					$window.sessionStorage.user = JSON.stringify(data.user);
				}
				
			});			
		},
		signOut: function(){
			cb = cb || angular.noop;
			delete $rootScope.user;
			delete $window.sessionStorage.token;
			delete $window.sessionStorage.user;
			delete $window.localStorage.token;
			delete $window.localStorage.user;
			$state.transitionTo('f.home');
		},
		changePass: function(oldPass, newPass, cb){
			cb = cb || angular.noop;
			serv.post('/api/changepass',{oldpass:oldpass, newpass:newpass}, function(data){
				cb("您的新密码已设置成功！")
			});
		},
		saveProfile: function(cb){
			cb = cb || angular.noop;
			serv.post('/api/user/profile',$rootScope.user.profile,function(data){
				cb("您的基本资料已设置成功！")
			});
		},
	};
}])
.factory('servSite', ["$rootScope", "$window", "serv", "$state", function($rootScope, $window, serv, $state) {
	return {
		init : function(){
			var site =  JSON.parse($window.localStorage.site || "{}");
			angular.forEach(site, function(value, key){
				$rootScope[key] = value;			
			});
			$rootScope.signOut = function(){
				delete $rootScope.user;
				delete $window.sessionStorage.token;
				delete $window.sessionStorage.user;
				delete $window.localStorage.token;
				delete $window.localStorage.user;
				$state.transitionTo('s.sign');
			};
			serv.get("/api/site?attachments=slides,cats,videos",function(data){
				angular.forEach(data, function(value, key){
					$rootScope[key] = value;	
				});
				$window.localStorage.site = JSON.stringify(data);	
			});
		},
	};
}])
.filter("filterCats", ["$window",function($window) {
	return function() {
		var args = Array.prototype.slice.call(arguments);  
		var result, lst = args[0], ctype = args[1], pkey = args[2] || "";
		var regex = new RegExp("^" + pkey +"\\d{2}$");
		return $window._.filter(lst, function(item){ return item.type == ctype && regex.test(item.key); });
	};
}])
.filter("filterSubByKey", ["$window",function($window) {
	return function(items, pkey) {
		if(pkey == ""){
			return $window._.filter(items, function(item){ return item.key.length == 2; });
		}else{
			var regex = new RegExp("^" + pkey +"\\d{2}$", "g");
			console.log(regex);
			return $window._.filter(items, function(item){ return regex.test(item.key); });
		}
	};
}])
.filter("filterVideos", ["$window",function($window) {
	return function() {
		var args = Array.prototype.slice.call(arguments); 
		var result, lst = args[0], ckey = args[1];
		var regex = new RegExp("^" + ckey);
		return $window._.filter(lst, function(item){ return $window._.find(item.cats, function(c){ return regex.test(c);}); });
		console.log(args);
	};
}])
.filter("filterGetValByKey", ["$window",function($window) {
	return function(item, lst, key, value) {
		var clct = $window._.find(lst, function(th){ return th[key] == item;});
		return clct[value];
	};
}])
.filter("filterNestspace",function(){
	return function(item){
		return item.substr(2).replace(/\d/g,"--");
	}
})
.filter("filterNestcolor",function(){
	return function(item){
		var len = item.length;
		if(len == 2){return "info";
		}else if(len == 4){ return "warning";
		} else { return "";}
	}
})
.directive("modalDialog",function(){
	return {
		restrict: 'E',
		scope: {
			key: '=',
			show: '=',
			dialogTitle: '@',
			onClose: '&?'
		},
		replace: true,
		transclude: true,
		link: function(scope, element, attrs) {
			var setupStyle;
			setupStyle = function() {
				scope.dialogStyle = {};
				if (attrs.width) {
					scope.dialogStyle['width'] = attrs.width;
				}
				if (attrs.height) {
					return scope.dialogStyle['height'] = attrs.height;
				}
			};
			scope.hideModal = function() {
				return scope.show = "";
			};
			scope.$watch('show', function(newVal, oldVal) {
				if (newVal == attrs.key) {
					document.getElementsByTagName("body")[0].style.overflow = "hidden";
					$(element).removeClass("ng-hide");
				} else {
					document.getElementsByTagName("body")[0].style.overflow = "";
					$(element).addClass("ng-hide");
				}
				if (newVal !== attrs.key && (scope.onClose != null)) {
					return scope.onClose();
				}
			});
			return setupStyle();
		},
		template: 	"<div class='ng-modal'>"+
						"<div class='ng-modal-overlay' ng-click='hideModal()'></div>"+
						"<div class='ng-modal-dialog' ng-style='dialogStyle'>"+
							"<span class='ng-modal-title' ng-show='dialogTitle && dialogTitle.length' ng-bind='dialogTitle'></span>"+
							"<div class='ng-modal-close' ng-click='hideModal()'>"+
								"<span ng-click='hideModal()' class='ng-modal-close-x'>X</span>"+
							"</div>"+
							"<div class='ng-modal-dialog-content' ng-transclude></div>"+
						"</div>"+
					"</div>",
	};
})
.directive("collapseNav",["$window",function($window){
	return{
		restrict:"A",
		link:function(scope,ele){
			var $aRest,$lists;
			$lists=ele.find("ul").parent("li"),
			$aRest=ele.children("li").not($lists).children("a"),
			ele.find("ul").parent("li").children("a").on("click",function(event){
				var $li=$(this).parent("li");
				var $li_left = $li.parent("ul").children("li").not($li);
				$li.find("ul").slideToggle();
				$li.toggleClass("active");
				$li.toggleClass("open");
				$li_left.find("ul").slideUp();
				$li_left.removeClass("active");
				$li_left.removeClass("open");
				event.preventDefault();
			});
			ele.find("ul").children("li").children("a").on("click",function(event){
				var $li=$(this).parent("li");
				var $li_left = $li.parent("ul").children("li").not($li);
				$li.addClass("active");
				$li_left.removeClass("active");
			});
			$aRest.on("click",function(){
				var $parent=$(this).parent("li");
				$parent.addClass("active");
				$lists.removeClass("active").find("ul").slideUp();
			});
		},
	};
}])
.directive("slideFluid",["$window","$timeout",function($window,$timeout){
	return{
		restrict:"A",
		link:function(scope,ele){
			var currentIndex = scope.currentIndex = -1;
			var destroyed = scope.destroyed = false;
			var currentTimeout = scope.currentTimeout = null;
			var isPlaying = scope.isPlaying = true;
			scope.select = function(idx) {
				if (currentIndex !== idx && !destroyed) {
					var $lists=ele.find(".g-wrap").children(".imgItem");
					var $lists_nav = ele.find(".slwrap").children(".item");
					$lists_nav.on("mouseenter",function(event){
						scope.isPlaying = false;
						scope.select($(this).index());
					});
					$lists_nav.on("mouseleave",function(event){
						scope.isPlaying = true;
						scope.select($(this).index()+1);
					});
					currentIndex = idx >= $lists.length ? idx - $lists.length : idx;
					var $cur = $($lists.get(currentIndex));
					var $cur_nav = $($lists_nav.get(currentIndex));
					$cur.addClass("selected");
					$lists.not($cur).removeClass("selected");
					$cur_nav.addClass("itempos");
					$lists_nav.not($cur_nav).removeClass("itempos");
					resetTimer();
					var interval = +3000;
					if (!isNaN(interval) && interval>=0) { 
						currentTimeout = $timeout(function(){
							if (isPlaying) { 
								scope.select(currentIndex + 1);
							} else if (!scope.noPause) { 
								isPlaying = false; 
								resetTimer(); 
							} 
						}, interval);  
					}
				}
			};
			scope.$on('$destroy', function () {
				destroyed = true;
				resetTimer();
			});
			function resetTimer() {
				if (currentTimeout) { 
					$timeout.cancel(currentTimeout); 
					currentTimeout = null; 
				}
			}
			scope.select(0);
		},
	};
}])
.directive("bsToggle",["$window",function($window){
	return{
		restrict:"A",
		link:function(scope,ele){
			var $btn=ele.find(".dropdown-toggle");
			$btn.on("click", function(event){
				$(this).parent(".btn-group").toggleClass("open");
				event.preventDefault();
			});
			ele.find("ul").children("li").children("a").on("click", function(event){
				$(this).parent(".btn-group").toggleClass("open");
			});
		},
	};
}])
.directive("bsTab",["$window",function($window){
	return{
		restrict:"A",
		link:function(scope,ele){
			var $lists=ele.find("ul.nav-tabs").children("li");
			$lists.children("a").on("click", function(event){
				var $li=$(this).parent("li");
				var $li_left = $li.parent("ul").children("li").not($li);
				var $pnl = $(ele.find(".tab-pane").get($li.index()));
				var $pnl_left = ele.find(".tab-pane").not($pnl);
				$pnl.addClass("active");
				$pnl_left.removeClass("active");
				$li_left.removeClass("active");
				$li.addClass("active");
				event.preventDefault();
			});
		},
	};
}])
.directive("bsCollapse",["$window",function($window){
	return{
		restrict:"A",
		link:function(scope,ele){
			var $lists=ele.find("a.nav-tabs").children("li");
			ele.find("a.collapse").on("click", function(event){
				var $i=$(this).children("i");
				if($i.hasClass("icon-chevron-up")){
					$(this).html('<i class="icon-chevron-down"></i>');
				}else{
					$(this).html('<i class="icon-chevron-up"></i>');
				}
				var $pnl = $(ele.find(".collapse-pane").get($(this).index()));
				$pnl.toggle();
				event.preventDefault();
			});
		},
	};
}])
.directive('scrollOffTop', ["$rootScope",function($rootScope) {
	return function(scope, elm, attr) {
		var raw = elm[0];
		elm.bind('scroll', function() {
			if (raw.scrollTop >= 310) {
				scope.$apply(function(){
					if($rootScope.toState.substr(0,3) == 'job'){
						$rootScope.showJobNav = true;
						console.log("$rootScope.showJobNav = true;");
						return;
					}
				});
			}
			$rootScope.showJobNav = false;
		});
	}
}])
.directive('scrollToBottom', function() {
    return function(scope, elm, attr) {
        var raw = elm[0];
        elm.bind('scroll', function() {
            if (raw.scrollTop + raw.offsetHeight >= raw.scrollHeight) {
                scope.$apply(attr.scrollToBottom);
            }
        });
    };
})
.directive('videojs', function() {
	var directive = {};
	directive.restrict = 'A';
	directive.replace = true;
	directive.scope = {
		options: '=',
		model: '=ngModel'
	};
	directive.link = function($scope, element, attributes) {
		$scope.scope = $scope;
		$scope.$watch("model", function(newValue) {
			document.body.scrollTop = document.documentElement.scrollTop = 0;
			if(newValue){
				var timer = setTimeout(function(){
					var vid = '_' + Math.random().toString(36).substr(2, 9);
					var face = '/img/slide3.jpg';

					var str = '<video id="video'+vid+'" class="video-js vjs-default-skin" controls="controls" autoplay="autoplay" ';
					str += 'width="100%" height="100%" ';
					str += 'data-setup=\'{"example_option":true, "customControlsOnMobile": true}\' id="play_video" ';
					str += 'poster="'+face+'" preload="none">';
					str += '<source src="'+newValue.url+'" type="video/mp4" />';
					str += '<object id="flash_fallback_1" class="vjs-flash-fallback" width="100%" height="100%" type="application/x-shockwave-flash" data="http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf">';
					str += '<param name="movie" value="http://releases.flowplayer.org/swf/flowplayer-3.2.1.swf" />';
					str += '<param name="allowfullscreen" value="true" />';
					str += '<param name="flashvars" value=\'config={"playlist":["'+face+'", {"url": "","autoPlay":false,"autoBuffering":true}]}\' />';
					str += '<img src="'+face+'" width="100%" height="100%" alt="" title="No video playback capabilities." />';
					str += '</object>';
					str += '</video>';
					element.html(str);
				},500);
			}else{
				element.html("<p style='color:#fff;font-size:15pt;padding:10px;font-weight:bolder;'>Loading............</p>");
			}
		});
	};
	return directive;	
})
.config(['$stateProvider', '$urlRouterProvider','$httpProvider', function ($stateProvider, $urlRouterProvider, $httpProvider) {
	$urlRouterProvider.otherwise("/");
	$stateProvider
		.state("f", {abstract: true, templateUrl: 'tpl/f/layout', controller:"FCtl"})
		.state("f.home", {url:'/',  templateUrl: 'tpl/f/home', controller:"FHomeCtl"})
		.state("f.cat", {url:'/cat/:id', templateUrl: 'tpl/f/cat',controller:'FCatCtl'})
		.state("f.video", {url:'/video/:id', templateUrl: 'tpl/f/video',controller:'FVideoCtl'})
		.state("s", {abstract:true, url:'/s',  templateUrl: 'tpl/s/layout', controller:"SignCtl"})
		.state("s.signin", {url:'/signin',  templateUrl: 'tpl/s/signin', controller:"SignCtl"})
		.state("s.signup", {url:'/signup',  templateUrl: 'tpl/s/signup', controller:"SignCtl"})
		.state("s.forgot", {url:'/forgot',  templateUrl: 'tpl/s/forgot', controller:"SignCtl"})
		.state("b", {abstract:true, url:'/b',  templateUrl: 'tpl/b/layout', controller:"BCtl"})
		.state("b.home", {url:'/home',  templateUrl: 'tpl/b/home', controller:"BHomeCtl"})
		.state("b.faq", {abstract:true, url:'/faq',  templateUrl: 'tpl/b/faq', controller:"BFaqCtl"})
		.state("b.faq.home", {url:'/home',  templateUrl: 'tpl/b/faq.home', controller:"BFaqCtl"})
		.state("b.faq.ask", {url:'/ask',  templateUrl: 'tpl/b/faq.ask', controller:"BFaqCtl"})
		.state("b.faq.answer", {url:'/answer',  templateUrl: 'tpl/b/faq.answer', controller:"BFaqCtl"})
		.state("b.account", {url:'/account',  templateUrl: 'tpl/b/account', controller:"BAccountCtl"})
		.state("b.profile", {url:'/profile',  templateUrl: 'tpl/b/profile', controller:"BProfileCtl"})
		.state("b.uppwd", {url:'/uppwd',  templateUrl: 'tpl/b/uppwd', controller:"BUppwdCtl"})
		.state("b.getvip", {url:'/getvip',  templateUrl: 'tpl/b/getvip', controller:"BGetvipCtl"})
		.state("b.buyvip", {url:'/buyvip',  templateUrl: 'tpl/b/buyvip', controller:"BBuyvipCtl"})
		.state("b.gcode", {url:'/gcode',  templateUrl: 'tpl/b/gcode', controller:"BGcodeCtl"})
		.state("b.data", {abstract:true, url:'/data',  templateUrl: 'tpl/b/data', controller:"BDataCtl"})
		.state("b.data.finance", {url:'/finance',  templateUrl: 'tpl/b/data.finance', controller:"BDataCtl"})
		.state("b.data.member", {url:'/member',  templateUrl: 'tpl/b/data.member', controller:"BDataCtl"})
		.state("b.data.promotion", {url:'/promotion',  templateUrl: 'tpl/b/data.promotion', controller:"BDataCtl"})
		.state("b.site", {abstract:true, url:'/site',  templateUrl: 'tpl/b/site', controller:"BSiteCtl"})
		.state("b.site.home", {url:'/home',  templateUrl: 'tpl/b/site.home', controller:"BSiteCtl"})
		.state("b.site.cat", {url:'/cat',  templateUrl: 'tpl/b/site.cat', controller:"BSiteCtl"})
		.state("b.site.video", {url:'/video',  templateUrl: 'tpl/b/site.video', controller:"BSiteCtl"})
		.state("b.site.d3", {url:'/d3',  templateUrl: 'tpl/b/site.d3', controller:"BSiteCtl"})
	$httpProvider.interceptors.push('authInterceptor');
}])
.controller("AppCtl",["$scope", "$state", function($scope, $state){
	$state.transitionTo('f.home');	
}])
.controller("FCtl",["$scope","$rootScope","$http","$window", function($scope,$rootScope,$http,$window){
}])
.controller("FHomeCtl",["$scope","$rootScope","$http","$window","$timeout", function($scope,$rootScope,$http,$window,$timeout){
	var slides = $rootScope.slides, currentTimeout, isPlaying=true, destroyed = false;
	var currentIndex = $scope.currentIndex = -1;

	$scope.select = function(idx) {
		if (currentIndex !== idx && !destroyed) {
			currentIndex = idx;
			resetTimer();
			var interval = +3000;
			if (!isNaN(interval) && interval>=0) { 
				currentTimeout = $timeout(function(){
					if (isPlaying) { 
						console.log("here");
						var newIndex = (currentIndex + 1) % $rootScope.slides.length;
						$scope.select(newIndex);
					} else if (!$scope.noPause) { 
						console.log("here2");
						isPlaying = false; 
						resetTimer(); 
					} 
				}, 1000);  
			}
		}
	};
	$scope.$on('$destroy', function () {
		destroyed = true;
		resetTimer();
	});
	function resetTimer() {
		if (currentTimeout) { 
			$timeout.cancel(currentTimeout); 
			currentTimeout = null; 
		}
	}
	$scope.select(0);
}])
.controller("FCatCtl",["$scope","$rootScope","$stateParams","$window",function($scope,$rootScope,$stateParams,$window){
	$scope.curCat =  $window._.find($rootScope.cats, function(cat){return cat.key == $stateParams.id;});
	console.log($scope.curCat);
}])
.controller("FVideoCtl",["$scope","$rootScope","$stateParams","$window","servVideo", function($scope,$rootScope,$stateParams,$window,servVideo){
	var regex = new RegExp("^\\d{2,12}$");
	if(regex.test($stateParams.id)){
		servVideo.getListByCatKey($stateParams.id, function(err, data){
			$scope.curVideoList = data;
			$scope.curVideo = $scope.curVideoList[0];
			servVideo.visit($scope.curVideo._id);
		});
	}else{
		servVideo.getById($stateParams.id, function(err, data){
			$scope.curVideo =  data;	
			$scope.curVideoList = [$scope.curVideo];
			servVideo.visit($stateParams.id);
		}); 
	}
}])
.controller("SignCtl",["$scope","$rootScope","$window","$state","servUser", function($scope,$rootScope,$window,$state,servUser){
	if($rootScope.user){$state.go("b.home");}
	$scope._id="";
	$scope.username="";
	$scope.password="";
	$scope.sms="";
	$scope.smsCaption="发送验证码";
	$scope.smsDisable = false;
	$scope.interval = 60;
	$scope.rememberme = false;

	$scope.sendSms = function(){
		servUser.sendSignSms($scope._id, "钱路书院", 60, function(err, left){
			$scope.smsCaption = left <= 0 ? "发送验证码" : left + " 秒后再次发送";
		});
	};
	$scope.signup = function(){
		var data = {_id:$scope._id, username:$scope.username, sms:$scope.sms, password:$scope.password};
		servUser.signUp(data, function(err, msg){
			$scope.msg = msg;
			if(!msg){
				$state.go("b.home");
			}
		});
	};
	$scope.signin = function(){
		servUser.signIn($scope.username, $scope.password, $scope.rememberme, function(err, msg){
			$scope.msg = msg;
			if(!msg){
				$state.go("b.home");
			}
		});
	}
	$scope.forget = function(){
		servUser.forgot($scope.username, $scope.password, $scope.sms, function(err, msg){
			$scope.msg = msg;
			if(!msg){
				$state.go("b.home");
			}
		});
	}
}])
.controller("BCtl",["$scope", "$rootScope","$state", function($scope,$rootScope,$state){
	if(!$rootScope.user){$state.go("f.sign");}
	$scope.tasks = [
		{title:"你还有30个问题没有关闭！", progress: 30, },
		{title:"你还有30个问题没有关闭！", progress: 30, },
		{title:"你还有30个问题没有关闭！", progress: 30, },
		{title:"你还有30个问题没有关闭！", progress: 30, },
	];
	$scope.alerts = [
		{color:"pink", icon:"comment", title:"您的VIP权限已超时！", num:"3"},
		{color:"pink", icon:"comment", title:"您的VIP权限已超时！", num:"3"},
		{color:"pink", icon:"comment", title:"您的VIP权限已超时！", num:"3"},
		{color:"pink", icon:"comment", title:"您的VIP权限已超时！", num:"3"},
	];
	$scope.msgs = [
		{from:{username:"叶辛", avatar:"assets/avatars/avatar.png"}, title:"您的VIP权限已超时！", create_at: Date.now()},
		{from:{username:"叶辛", avatar:"assets/avatars/avatar.png"}, title:"您的VIP权限已超时！", create_at: Date.now()},
		{from:{username:"叶辛", avatar:"assets/avatars/avatar.png"}, title:"您的VIP权限已超时！", create_at: Date.now()},
	];
	//Socket.connect(host,port,data._id,$rootScope.token);
}])
.controller("BHomeCtl",["$scope","$rootScope","$state","servVideo", function($scope,$rootScope,$state,servVideo){
	$scope.myVideos = [];
	servVideo.getMyVisitList(function(err, lst){
		$scope.myVideos = lst;
	});
}])
.controller("BFaqCtl",["$scope","$rootScope","$state", function($scope,$rootScope,$state){
}])
.controller("BAccountCtl",["$scope","$rootScope","$state", function($scope,$rootScope,$state){
}])
.controller("BProfileCtl",["$scope","$rootScope","servUser", function($scope,$rootScope,servUser){
	$scope.doSubmit = function(){
		servUser.saveProfile(function(err, msg){
			$scope.msg = msg;
		});
	}
}])
.controller("BUppwdCtl",["$scope", "$rootScope","servUser", function($scope,$rootScope,servUser){
	$scope.doSubmit = function(){
		if(!$scope.oldpassword || !$scope.password){
			$scope.msg = "密码不能为空，请正确输入！";
		}else if($scope.password !== $scope.password2){
			$scope.msg = "新密码两次输入不一致，请正确输入！";
		}else{
			servUser.changePass($scope.oldpassword, $scope.password, function(err, msg){
				$scope.msg = msg;
			});
		}
	};
	$scope.doReset = function(){
		$scope.msg = "";
		$scope.oldpassword = "";
		$scope.password = "";
		$scope.password2 = "";
	};
	$scope.doReset();
}])
.controller("BGetvipCtl",["$scope","$rootScope","$state", function($scope,$rootScope,$state){

}])
.controller("BBuyvipCtl",["$scope","$rootScope","$state", function($scope,$rootScope,$state){
	$scope.buy = function(level){
		var parameter = {
			total_fee : 2380,
			subject : "VIP会员",
			body : "钱路书院VIP会员年费"
		};
  			$http.post('/api/alipay/create_direct_pay_by_user_location/qianlushuyuan', parameter).success(function(data){
  				$window.location.href = data.location;
  			});
	};	
}])
.controller("BGcodeCtl",["$scope","$rootScope","$state", function($scope,$rootScope,$state){
}])
.controller("BDataCtl",["$scope","$rootScope","$state", function($scope,$rootScope,$state){
}])
.controller("BSiteCtl",["$scope","$rootScope","$http","$window","servCat","servVideo", function($scope,$rootScope,$http,$window,servCat,servVideo){
	$scope.selCatType = function(t){
		$scope.curCatType = t;
		if(t == "video"){$scope.curCatTypeCaption = "视频"}
		else if(t == "article"){$scope.curCatTypeCaption = "文章"}	
	}
	$scope.selCatType('video');
	$scope.addSubCat = function(cat){
		cat = cat || {key: "", type: $scope.curCatType};
		servCat.newOne(cat, function(err, data){
			$scope.editCat(data);
		});
		$scope.curCatTip = cat.key ? "作为 [" + cat.title + "] 的子类" : "作为顶级分类";
	}
	$scope.editCat = function(cat){
		$scope.curCat = cat;
		servVideo.getListByCatKey(cat.key, function(err, data){
			$scope.curVideoList = data;
		});
		$scope.newVideo();
	}
	$scope.saveCat = function(){
		servCat.save($scope.curCat, function(err, msg){
			$scope.msg = msg;
		});
	}
	$scope.delCat = function(){
		servCat.del($scope.curCat, function(err, msg){
			$scope.msg = msg;
		});
		$scope.addSubCat();
	}
	$scope.newVideo = function(){
		servVideo.newOne(function(err, data){
			if($scope.curCat && $scope.curCat.type == "video"){
				data.cats.push($scope.curCat.key);
				$scope.curVideoTip = "归类于 [" + $scope.curCat.title + "] ";
			}
			$scope.editVideo(data);
		});
	}
	$scope.editVideo = function(video){
		$scope.curVideo = video;
	}
	$scope.saveVideo = function(){
		servVideo.save($scope.curVideo, function(err, msg){
			$scope.msg = msg;
		});
	}
	$scope.delVideo = function(){
		servVideo.del($scope.curVideo, function(err, msg){
			$scope.msg = msg;
		});
	}
	$scope.addVideoCat = function(key){
		$scope.curVideo.cats.splice(0,0,key);
		$scope.saveVideo();
	}
	$scope.delVideoCat = function(key){
		var idx = $window._.findIndex($scope.curVideo.cats, key);
		if(idx > -1){
			$scope.curVideo.cats.splice(idx,1);	
		}
		$scope.saveVideo();
	}

	$scope.addSubCat();
}])
.run(['$rootScope', '$location', '$window', 'servUser', 'servSite', function ($rootScope, $location, $window, servUser,servSite) {
	servUser.init();
	servSite.init();
	$rootScope.$on('$stateChangeStart', function(event, toState, toParams, fromState, fromParams){
		$rootScope.toState = toState;
		$rootScope.toParams = toParams;
		$rootScope.fromState = fromState;
		$rootScope.fromParams = fromParams;
		$rootScope.bodycss = $rootScope.toState.name.substr(0,2) == 's.' ? "login-layout" : "";
	});

	$rootScope.mdData = {
		org: "钱路书院",
		show: "", //显示哪个Modal
		mobile:"",
		email:"",
		sms:"",
		username:"",
		password:"",
		smsCaption: "发送验证码",
		smsDisable: false,
		smsInterval: 60,
		rememberme: true,
		agree: true,
		msg: "",
	};
	$rootScope.toggleModal = function(key){
		$rootScope.mdData.msg = "";
		$rootScope.mdData.show = key;
		console.log($rootScope.mdData);
	}

	$rootScope.sendSignSms = function(){
		servUser.sendSignSms($rootScope.mdData, function(err, left){
			$rootScope.mdData.smsCaption = left <= 0 ? "发送验证码" : left + " 秒后再次发送";
		});
	};
	$rootScope.doSignup = function(){
		servUser.signUp($rootScope.mdData, function(err, msg){
			$scope.msg = msg;
			if(!msg){
				$rootScope.mdData.show = "";
				$state.go("b.home");
			}
		});
	};
	$rootScope.doSignin = function(){
		servUser.signIn($rootScope.mdData, function(err, msg){
			$scope.msg = msg;
			if(!msg){
				$rootScope.mdData.show = "";
				$state.go("b.home");
			}
		});
	}
	$rootScope.doForgotByEmail = function(){
		servUser.forgot($rootScope.mdData, function(err, msg){
			$scope.msg = msg;
			if(!msg){
				$rootScope.mdData.show = "";
				$state.go("b.home");
			}
		});
	}

}]);


</script>


</body>
</html>
